<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D365FO Automation Studio</title>
    <link rel="stylesheet" href="popup.css">
</head>
<body>
    <div class="app-container">
        <!-- Main Panel -->
        <div class="main-panel">
            <header>
                <h1>ü§ñ D365FO Automation</h1>
                <div class="header-right">
                    <button id="toggleLogs" class="btn-icon-sm" title="Toggle Logs Panel">üìã</button>
                    <div class="status" id="status">
                        <span class="status-indicator"></span>
                        <span class="status-text">Not connected</span>
                    </div>
                </div>
            </header>

            <nav class="tabs">
                <button class="tab active" data-tab="workflows">Workflows</button>
                <button class="tab" data-tab="builder">Builder</button>
                <button class="tab" data-tab="data-sources">Data Sources</button>
                <button class="tab" data-tab="nav-buttons">Nav Buttons</button>
                <button class="tab" data-tab="inspector">Inspector</button>
                <button class="tab" data-tab="settings">Settings</button>
            </nav>

            <!-- Execution Status Bar (shown when running) -->
            <div class="execution-bar is-hidden" id="executionBar">
                <div class="execution-info">
                    <div class="execution-status">
                        <span class="running-indicator" id="runningIndicator"></span>
                        <span id="executionStatus">Running...</span>
                    </div>
                    <div class="execution-details">
                        <span id="executionStep">Step 1/10</span>
                        <span class="separator">‚Ä¢</span>
                        <span id="executionRow">Row 1/100</span>
                    </div>
                </div>
                <div class="execution-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="execution-controls">
                    <button id="pauseBtn" class="btn btn-sm btn-warning" title="Pause">‚è∏Ô∏è Pause</button>
                    <button id="resumeBtn" class="btn btn-sm btn-success is-hidden" title="Resume">‚ñ∂Ô∏è Resume</button>
                    <button id="stopBtn" class="btn btn-sm btn-danger" title="Stop">‚èπÔ∏è Stop</button>
                </div>
            </div>            <!-- Workflows Tab -->
            <div class="tab-content active" id="workflows-tab">
                <div class="workflows-shell">
                    <aside class="workflow-tree-pane" id="workflowTreePane">
                        <div class="workflow-tree-header">
                            <button id="workflowTreeToggle" class="btn btn-secondary btn-sm tree-toggle-btn" title="Toggle tree pane" aria-label="Toggle tree pane">&#9776;</button>
                            <button id="showAllWorkflows" class="btn btn-secondary btn-sm">All workflows</button>
                        </div>

                        <details class="tree-group" open>
                            <summary>
                                <span>Projects</span>
                                <button id="addProjectQuick" class="tree-summary-action" title="Add project" aria-label="Add project">+</button>
                            </summary>
                            <div id="projectsTree" class="tree-list"></div>
                            <select id="projectFilter" class="form-control form-control-sm is-hidden"></select>
                        </details>

                        <details class="tree-group" open>
                            <summary>
                                <span>Configurations</span>
                                <button id="addConfigurationQuick" class="tree-summary-action" title="Add configuration" aria-label="Add configuration">+</button>
                            </summary>
                            <div class="projects-manager" id="configurationsManager">
                                <div class="projects-manager-header">
                                    <button id="runConfiguration" class="btn btn-primary btn-sm btn-block">Run selected configuration</button>
                                </div>
                            </div>
                            <div id="configurationsTree" class="tree-list"></div>
                            <select id="configurationFilter" class="form-control form-control-sm is-hidden"></select>
                        </details>
                    </aside>

                    <div class="workflows-main">
                        <div class="toolbar">
                            <button id="newWorkflow" class="btn btn-primary">
                                <span>‚ûï</span> New Workflow
                            </button>
                            <div class="import-dropdown">
                                <button id="importWorkflow" class="btn btn-secondary">
                                    <span>üì•</span> Import ‚ñæ
                                </button>
                                <div class="import-dropdown-menu" id="importDropdownMenu">
                                    <button class="import-option" data-import-type="json">
                                        <span>üìÑ</span> Import JSON Workflow
                                    </button>
                                    <button class="import-option" data-import-type="xml">
                                        <span>üé¨</span> Import Task Recording (XML)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="workflowsList" class="workflows-list">
                            <!-- Workflows will be listed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Builder Tab -->
            <div class="tab-content" id="builder-tab">
                <div class="builder-header">
                    <input type="text" id="workflowName" placeholder="Workflow Name" class="workflow-name-input">
                    <div class="linked-tab-info" id="linkedTabInfo">
                        <span class="linked-icon">üîó</span>
                        <span id="linkedTabName">No tab linked</span>
                    </div>
                                </div>

                <div class="builder-top-panels">
                    <div id="workflowConfigurationsPanel" class="workflow-projects-panel builder-panel" data-panel-key="configurations">
                        <div class="workflow-projects-header">
                            <h3>Configurations</h3>
                            <span class="muted">Assign this workflow to one or more configurations.</span>
                        </div>
                        <div id="workflowConfigurationsList" class="workflow-projects-list builder-panel-body"></div>
                    </div>

                    <div id="workflowProjectsPanel" class="workflow-projects-panel builder-panel" data-panel-key="projects">
                        <div class="workflow-projects-header">
                            <h3>Projects</h3>
                            <span class="muted">Assign this workflow to one or more projects.</span>
                        </div>
                        <div id="workflowProjectsList" class="workflow-projects-list builder-panel-body"></div>
                    </div>

                    <div id="workflowDefaultsPanel" class="workflow-defaults-panel builder-panel" data-panel-key="workflow-defaults">
                        <div class="workflow-projects-header">
                            <h3>Workflow Defaults</h3>
                            <span class="muted">Default error handling and retries for this workflow.</span>
                        </div>
                        <div class="workflow-defaults-grid builder-panel-body">
                            <div class="form-group">
                                <label>On Error (default)</label>
                                <select id="workflowErrorDefaultMode" class="form-control">
                                    <option value="fail">Fail workflow</option>
                                    <option value="skip">Skip step</option>
                                    <option value="goto">Go to label</option>
                                    <option value="break-loop">Break loop</option>
                                    <option value="continue-loop">Continue loop</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Retry Count</label>
                                <input type="number" id="workflowErrorDefaultRetryCount" class="form-control" min="0">
                            </div>
                            <div class="form-group">
                                <label>Retry Delay (ms)</label>
                                <input type="number" id="workflowErrorDefaultRetryDelay" class="form-control" min="0">
                            </div>
                            <div class="form-group" id="workflowErrorDefaultGotoGroup">
                                <label>Go To Label</label>
                                <select id="workflowErrorDefaultGotoLabel" class="form-control">
                                    <option value="">No labels defined</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="workflowInterruptionHandlersPanel" class="workflow-defaults-panel builder-panel" data-panel-key="interruption-handlers">
                        <div class="workflow-projects-header">
                            <h3>Interruption Handlers</h3>
                            <span class="muted">Learned rules for dialogs and warnings.</span>
                        </div>
                        <div id="interruptionHandlersList" class="interruption-handlers-list builder-panel-body">
                            <p class="empty-state">Open a workflow to view learned handlers.</p>
                        </div>
                    </div>
                </div>

                <!-- Main Builder Area -->
                <div class="builder-main">
                    <!-- Steps Panel -->
                    <div class="steps-panel" id="stepsPanel">
                        <h3>Workflow Steps</h3>
                        <div class="steps-toolbar">
                            <label class="steps-select-all">
                                <input type="checkbox" id="stepsSelectAll">
                                Select all
                            </label>
                            <div class="steps-copy-controls">
                                <select id="copyStepsTarget" class="form-control form-control-sm"></select>
                                <button id="copyStepsButton" class="btn btn-secondary btn-sm" disabled>Copy from workflow</button>
                            </div>
                        </div>
                        <div id="stepsList" class="steps-list">
                            <!-- Steps will be added here -->
                        </div>
                        <button id="addStep" class="btn btn-primary btn-block">
                            ‚ûï Add Step
                        </button>
                    </div>

                    <!-- Step Editor -->
                    <div class="step-editor-overlay is-hidden" id="stepEditorOverlay">
                        <div class="step-editor-header">
                            <h3 id="stepEditorTitle">Edit Step</h3>
                            <button id="closeEditor" class="btn-close">‚úï</button>
                        </div>
                        <div class="step-editor-body">
                            <div class="form-group">
                                <label>Step Type</label>
                                <select id="stepType" class="form-control">
                                    <optgroup label="Basic Actions">
                                        <option value="click">Click Button</option>
                                        <option value="input">Enter Text</option>
                                        <option value="select">Select from Dropdown</option>
                                        <option value="lookupSelect">Lookup Select (open picker)</option>
                                        <option value="checkbox">Toggle Checkbox</option>
                                    </optgroup>
                                    <optgroup label="Navigation">
                                        <option value="navigate">üß≠ Navigate to Form</option>
                                        <option value="tab-navigate">üìë Switch Tab</option>
                                        <option value="action-pane-tab">üéõÔ∏è Action Pane Tab</option>
                                        <option value="expand-section">üìÇ Expand/Collapse Section</option>
                                    </optgroup>
                                    <optgroup label="Control Flow">
                                        <option value="if-start">üîÄ If Condition</option>
                                        <option value="else">‚ÜîÔ∏è Else</option>
                                        <option value="if-end">‚úÖ End If</option>
                                        <option value="continue-loop">‚è≠ Continue Loop</option>
                                        <option value="break-loop">‚èπ Break Loop</option>
                                        <option value="label">üè∑Ô∏è Label</option>
                                        <option value="goto">‚Ü™Ô∏è Go To Label</option>
                                    </optgroup>
                                    <optgroup label="Grid & Filtering">
                                        <option value="filter">üîç Filter Grid Column</option>
                                        <option value="grid-input">üìù Grid Cell Input</option>
                                        <option value="query-filter">üîé Query Filter (Records to include)</option>
                                    </optgroup>
                                    <optgroup label="Batch Job Configuration">
                                        <option value="batch-processing">‚öôÔ∏è Toggle Batch Processing</option>
                                        <option value="recurrence">üîÅ Configure Recurrence</option>
                                    </optgroup>
                                    <optgroup label="Dialog & Timing">
                                        <option value="close-dialog">‚úì Close Dialog (OK/Cancel)</option>
                                        <option value="wait">Wait/Delay</option>
                                        <option value="wait-until">‚è≥ Wait Until Visible</option>
                                        <option value="loop-start">üîÑ Loop Start</option>
                                        <option value="loop-end">üîÑ Loop End</option>
                                    </optgroup>
                                    <optgroup label="Workflow">
                                        <option value="subworkflow">Call Subworkflow</option>
                                    </optgroup>
                                </select>
                            </div>

                            <div id="stepTypeFields">
                                <!-- Dynamic fields based on step type -->
                            </div>

                            <div class="form-actions">
                                <button id="deleteStep" class="btn btn-danger is-hidden">üóëÔ∏è Delete Step</button>
                                <button id="cancelStep" class="btn btn-secondary">Done</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Actions -->
                <div class="workflow-actions-bar">
                    <button id="cancelWorkflow" class="btn btn-secondary">Cancel Changes</button>
                    <button id="saveWorkflow" class="btn btn-success">üíæ Save Workflow</button>
                </div>
            </div>

            <!-- Data Sources Tab -->
            <div class="tab-content" id="data-sources-tab">
                <div class="data-sources-panel">
                    <div class="panel-header" id="dataSourcesHeader">
                        <h3>üìä Data Sources</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="panel-body" id="dataSourcesBody">
                        <div class="data-sources-layout">
                            <aside class="data-sources-project-pane">
                                <div class="data-source-section">
                                    <div class="data-source-header">
                                        <h4>Projects</h4>
                                    </div>
                                    <div class="tree-list" id="dataSourcesProjectsTree"></div>
                                </div>
                            </aside>

                            <div class="data-sources-main-pane" id="dataSourcesMainPane">
                                <div class="data-sources-list-pane" id="dataSourcesListPane">
                                    <div class="data-source-section">
                                        <div class="data-source-header">
                                            <h4>1. Existing Data Sources</h4>
                                            <button id="newSharedDataSource" class="btn btn-secondary btn-sm">New Data Source</button>
                                        </div>
                                        <div id="sharedDataSourcesList" class="shared-data-sources-list"></div>
                                    </div>
                                </div>

                                <div class="data-sources-pane-resizer" id="dataSourcesPaneResizer" role="separator" aria-orientation="vertical" aria-label="Resize data source panes"></div>

                                <div class="data-sources-editor-pane" id="dataSourcesEditorPane">
                                    <div class="data-source-section">
                                        <div class="data-source-header collapsible" id="dataSourceEditorHeader">
                                            <h4>2. Create / Edit Data Source</h4>
                                            <div class="data-source-header-actions">
                                                <button id="newSharedDataSourceSecondary" class="btn btn-secondary btn-sm">New Data Source</button>
                                                <span id="dataSourceEditorToggleIcon" class="toggle-icon-inline">‚ñº</span>
                                                <select id="primaryDataSourceType" class="form-control form-control-sm">
                                                    <option value="json">JSON</option>
                                                    <option value="csv">CSV / TSV</option>
                                                    <option value="odata-cached">OData (Cached)</option>
                                                    <option value="odata-dynamic">OData (Dynamic)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div id="dataSourceEditorSectionBody">
                                            <div id="primaryODataQueryContainer" class="data-source-input is-hidden">
                                                <input id="primaryODataQuery" class="form-control form-control-sm" placeholder="CustomersV3?$top=10&$filter=CustomerGroupId eq 'C-DOM'&$select=CustomerAccount,CustomerGroupId,FullPrimaryAddress">
                                            </div>
                                            <div id="primaryODataDynamicNote" class="odata-note is-hidden">
                                                Dynamic OData validates with a preview row for field detection. Full query results are fetched right before workflow execution.
                                            </div>
                                            <div id="primaryDataSourceInput" class="data-source-input is-hidden">
                                                <textarea id="primaryDataInput" class="form-control editor-expanded" placeholder="Paste shared data here..." rows="3"></textarea>
                                                <div class="data-source-actions">
                                                    <button id="validatePrimaryData" class="btn btn-secondary btn-sm">Validate</button>
                                                    <span id="primaryDataStatus" class="data-status"></span>
                                                </div>
                                            </div>
                                            <div id="primaryDataFields" class="data-fields-preview"></div>
                                        </div>
                                    </div>

                                    <div class="data-source-section" id="dataSourceSaveSection">
                                        <div class="data-source-header">
                                            <h4>3. Save / Delete</h4>
                                        </div>
                                        <div class="data-source-input">
                                            <div class="data-source-actions">
                                                <input id="sharedDataSourceName" class="form-control form-control-sm" placeholder="Data source name" style="min-width: 180px;">
                                                <button id="saveAsSharedDataSource" class="btn btn-secondary btn-sm">Save</button>
                                                <button id="refreshSharedDataSources" class="btn btn-secondary btn-sm">Refresh</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="data-source-section" id="dataSourceProjectLinksSection">
                                        <div class="data-source-header">
                                            <h4>Linked Projects (filter only)</h4>
                                        </div>
                                        <div id="dataSourceProjectLinks" class="workflow-projects-list"></div>
                                    </div>

                                    <div class="data-source-section" id="dataSourceRelationshipsSection">
                                        <div class="data-source-header">
                                            <h4>Relationships (nested loops)</h4>
                                        </div>
                                        <div class="relationship-builder">
                                            <div id="relationshipScopeInfo" class="relationship-scope-info"></div>
                                            <div class="relationship-grid">
                                                <div class="relationship-cell">
                                                    <label>Parent Source</label>
                                                    <select id="relationshipParentSource" class="form-control form-control-sm"></select>
                                                </div>
                                                <div class="relationship-cell">
                                                    <label>Child Source</label>
                                                    <select id="relationshipDetailSource" class="form-control form-control-sm"></select>
                                                </div>
                                            </div>
                                            <div id="relationshipFieldPairs" class="relationship-pairs"></div>
                                            <div class="data-source-actions">
                                                <button id="addRelationshipFieldPair" class="btn btn-secondary btn-sm">Add Field Pair</button>
                                                <button id="addDataSourceRelationship" class="btn btn-secondary btn-sm">Save Relationship</button>
                                            </div>
                                            <div id="dataSourceRelationshipsList" class="relationship-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inspector Tab -->
            <div class="tab-content" id="inspector-tab">
                <div class="inspector-toolbar">
                    <button id="startInspector" class="btn btn-primary">
                        üîç Start Inspector
                    </button>
                    <button id="refreshElements" class="btn btn-secondary">
                        üîÑ Refresh
                    </button>
                </div>

                <div class="inspector-info">
                    <p>Click "Start Inspector" to discover elements on the page.</p>
                    <div class="form-group" style="margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                            <input type="checkbox" id="activeFormOnly">
                            Show only active form elements
                        </label>
                    </div>
                    <div id="activeFormInfo" class="is-hidden" style="font-size: 11px; color: #666; margin-top: 4px;">
                        Active form: <strong id="activeFormName">-</strong>
                    </div>
                </div>

                <div class="elements-filter">
                    <input type="text" id="elementFilter" class="form-control" placeholder="Filter elements...">
                    <select id="elementTypeFilter" class="form-control">
                        <option value="all">All Types</option>
                        <option value="button">Buttons</option>
                        <option value="input">Inputs</option>
                        <option value="checkbox">Checkboxes</option>
                        <option value="action-pane-tab">Action Pane Tabs</option>
                        <option value="grid">Grids</option>
                        <option value="grid-column">Grid Columns</option>
                    </select>
                </div>
                
                <div class="elements-filter" style="margin-top: 4px;">
                    <select id="formFilter" class="form-control">
                        <option value="all">All Forms</option>
                    </select>
                </div>

                <div id="elementsList" class="elements-list">
                    <!-- Discovered elements will be listed here -->
                </div>
            </div>

            <!-- Nav Buttons Tab -->
            <div class="tab-content" id="nav-buttons-tab">
                <div class="nav-buttons-header">
                    <div class="current-menu-item">
                        <span>Current menu item:</span>
                        <strong id="navButtonCurrentMenu">None detected</strong>
                    </div>
                    <button id="navButtonRefreshContext" class="btn btn-secondary btn-sm">Refresh</button>
                </div>

                <div class="toolbar">
                    <button id="newNavButton" class="btn btn-primary">
                        New Button
                    </button>
                    <div class="nav-search">
                        <input type="text" id="navButtonSearch" class="form-control" placeholder="Search by name, menu item, workflow">
                    </div>
                </div>

                <div class="nav-buttons-filters">
                    <div class="form-group">
                        <label>Menu item filter</label>
                        <input type="text" id="navButtonMenuFilter" class="form-control form-control-sm" placeholder="e.g., CustTable">
                    </div>
                    <div class="form-group">
                        <label>Workflow filter</label>
                        <select id="navButtonWorkflowFilter" class="form-control form-control-sm"></select>
                    </div>
                </div>

                <div class="nav-button-editor is-hidden" id="navButtonEditor">
                    <div class="nav-button-editor-header">
                        <h3 id="navButtonEditorTitle">New Nav Button</h3>
                        <button id="navButtonClose" class="btn-close">x</button>
                    </div>
                    <div class="nav-button-editor-body">
                        <div class="form-group">
                            <label>Button name</label>
                            <input type="text" id="navButtonName" class="form-control" placeholder="e.g., Open approvals">
                        </div>
                        <div class="form-group">
                            <label>Workflow</label>
                            <select id="navButtonWorkflowId" class="form-control"></select>
                        </div>
                        <div class="form-group">
                            <label>Parameters</label>
                            <div class="param-table" id="navButtonParamsTable"></div>
                            <button id="navButtonAddParam" class="btn btn-secondary btn-sm" type="button">Add parameter</button>
                            <small>Use \${ParameterName} placeholders from the linked workflow. Names are case-insensitive.</small>
                        </div>
                        <div class="form-group">
                            <label>Group (optional)</label>
                            <input type="text" id="navButtonGroup" class="form-control" placeholder="e.g., Master Data">
                            <small>Buttons with the same group are collapsed under one expandable group in the dashboard.</small>
                        </div>
                        <div class="form-group">
                            <label>Menu items (comma-separated)</label>
                            <input type="text" id="navButtonMenuItems" class="form-control" placeholder="e.g., CustTable, SalesTable">
                            <small>Leave empty to make this button global.</small>
                            <div class="nav-button-inline-actions">
                                <button id="navButtonUseCurrentMenu" class="btn btn-secondary btn-sm">Use current menu item</button>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button id="navButtonDelete" class="btn btn-danger is-hidden">Delete</button>
                            <button id="navButtonCancel" class="btn btn-secondary">Cancel</button>
                            <button id="navButtonSave" class="btn btn-success">Save</button>
                        </div>
                    </div>
                </div>

                <div id="navButtonsList" class="nav-buttons-list"></div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings-tab">
                <div class="settings-scroll">
                    <h3>Timing Settings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Delay After Click (ms)</label>
                            <input type="number" id="delayAfterClick" class="form-control" value="800">
                        </div>
                        <div class="form-group">
                            <label>Delay After Input (ms)</label>
                            <input type="number" id="delayAfterInput" class="form-control" value="400">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Delay After Save (ms)</label>
                            <input type="number" id="delayAfterSave" class="form-control" value="1000">
                        </div>
                        <div class="form-group">
                            <label>Maximum Retries</label>
                            <input type="number" id="maxRetries" class="form-control" value="3">
                        </div>
                    </div>

                    <h3>Advanced Settings</h3>
                    <div class="form-group">
                        <label><input type="checkbox" id="logVerbose"> Enable Verbose Logging</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="pauseOnError"> Pause on Error</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="suppressLookupWarnings"> Suppress Lookup Warnings</label>
                    </div>
                    <div class="form-group">
                        <label>ComboBox Input Method</label>
                        <select id="comboSelectMode" class="form-control">
                            <option value="method1">Method 1: Basic setValue</option>
                            <option value="method2">Method 2: Paste simulation</option>
                            <option value="method3" selected>Method 3: Char-by-char (recommended)</option>
                            <option value="method4">Method 4: With keypress</option>
                            <option value="method5">Method 5: execCommand</option>
                            <option value="method6">Method 6: Paste + Backspace</option>
                            <option value="method7">Method 7: D365 internal trigger</option>
                            <option value="method8">Method 8: Composition events</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Label language for enum resolution</label>
                        <input type="text" id="labelLanguage" class="form-control" value="en-us" placeholder="e.g. en-us">
                        <small style="display:block;margin-top:6px;color:#666;">Used when resolving D365 label keys (e.g. @SYS123) via OData.</small>
                    </div>

                    <div class="form-group">
                        <label>Date format for D365</label>
                        <select id="dateFormat" class="form-control">
                            <option value="DDMMYYYY" selected>DD/MM/YYYY (e.g., 28012026)</option>
                            <option value="MMDDYYYY">MM/DD/YYYY (e.g., 01282026)</option>
                            <option value="YYYYMMDD">YYYY-MM-DD (ISO format)</option>
                        </select>
                        <small style="display:block;margin-top:6px;color:#666;">Format for date values imported from Task Recorder XML.</small>
                    </div>

                    <div class="btn-group-vertical">
                        <button id="saveSettings" class="btn btn-success">Save Settings</button>
                        <button id="resetSettings" class="btn btn-secondary">Reset to Defaults</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Panel (Collapsible Side Panel) -->
        <div class="logs-panel" id="logsPanel">
            <div class="logs-header">
                <h3>üìã Execution Logs</h3>
                <div class="logs-controls">
                    <button id="clearLogs" class="btn-icon-sm" title="Clear Logs">üóëÔ∏è</button>
                    <button id="exportLogs" class="btn-icon-sm" title="Export Logs">üì•</button>
                    <button id="closeLogs" class="btn-icon-sm" title="Close">‚úï</button>
                </div>
            </div>
            <div class="logs-filter">
                <select id="logLevelFilter" class="form-control form-control-sm">
                    <option value="all">All Levels</option>
                    <option value="info">Info</option>
                    <option value="success">Success</option>
                    <option value="warning">Warning</option>
                    <option value="error">Error</option>
                </select>
            </div>
            <div class="logs-content" id="logsContent">
                <!-- Logs will be added here -->
                <div class="log-empty">No logs yet. Run a workflow to see execution logs.</div>
            </div>
        </div>

        <!-- Run Options Modal -->
        <div class="modal-overlay is-hidden" id="runOptionsModal">
            <div class="modal">
                <div class="modal-header">
                    <h3>‚ñ∂Ô∏è Run Options</h3>
                    <button class="btn-close" id="closeRunOptions">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Skip first N rows</label>
                        <input type="number" id="runSkipRows" class="form-control" value="0" min="0">
                        <small>Start processing from row N+1 (useful for resuming)</small>
                    </div>
                    <div class="form-group">
                        <label>Limit to N rows</label>
                        <input type="number" id="runLimitRows" class="form-control" value="0" min="0">
                        <small>0 = process all rows (useful for testing)</small>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="runWithLogs" checked> Show execution logs</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="runDryMode"> üî¨ Dry run (preview only, no actions)</label>
                        <small>See what would happen without making changes</small>
                    </div>
                    <div class="form-group">
                        <div class="run-learning-row">
                            <label><input type="checkbox" id="runLearningMode"> Learning mode</label>
                            <select id="runLearningModeBehavior" class="form-control form-control-sm">
                                <option value="until-interception" selected>Until next interception</option>
                                <option value="confirm-each-step">Confirm each step</option>
                            </select>
                        </div>
                        <small>Learn interruption handlers. Choose whether to pause only on interruptions or before every step.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancelRun" class="btn btn-secondary">Cancel</button>
                    <button id="confirmRun" class="btn btn-success">‚ñ∂Ô∏è Start</button>
                </div>
            </div>
        </div>

        <!-- Learning Interruption Modal -->
        <div class="modal-overlay is-hidden" id="interruptionModal">
            <div class="modal">
                <div class="modal-header">
                    <h3>Interruption Detected</h3>
                    <button class="btn-close" id="closeInterruptionModal">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Type</label>
                        <div id="interruptionKindText">-</div>
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <div id="interruptionMessageText" style="font-size: 12px; line-height: 1.4; max-height: 120px; overflow: auto; background: #f8fafc; border: 1px solid #dbeafe; border-radius: 6px; padding: 8px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Choose D365 operation</label>
                        <select id="interruptionActionSelect" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label>Then click (optional)</label>
                        <select id="interruptionFollowupActionSelect" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label>After action</label>
                        <select id="interruptionOutcomeSelect" class="form-control">
                            <option value="next-step">Continue with next step</option>
                            <option value="continue-loop">Continue loop (next iteration)</option>
                            <option value="repeat-loop">Repeat current loop iteration</option>
                            <option value="break-loop">Break current loop</option>
                            <option value="stop">Stop workflow</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Rule matching</label>
                        <select id="interruptionMatchModeSelect" class="form-control">
                            <option value="contains">Dynamic text match (recommended)</option>
                            <option value="exact">Exact text match</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="interruptionSaveRule" checked> Save as automatic handler rule</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="interruptionStopBtn" class="btn btn-danger">Stop</button>
                    <button id="interruptionSkipBtn" class="btn btn-secondary">No click, continue</button>
                    <button id="interruptionApplyBtn" class="btn btn-success">Apply selected action</button>
                </div>
            </div>
        </div>
    </div>


        <!-- Resume Modal -->
        <div class="modal-overlay resume-modal is-hidden" id="resumeModal">
            <div class="modal">
                <div class="modal-header">
                    <h3>Resume Workflow</h3>
                    <button class="btn-close" id="closeResumeModal">!</button>
                </div>
                <div class="modal-body">
                    <div class="resume-message" id="resumeMessage">
                        The workflow stopped at row 1.
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="resume-actions">
                        <button id="resumeCancel" class="btn btn-secondary">Cancel</button>
                        <button id="resumeThisRecord" class="btn btn-primary">Resume from this record</button>
                        <button id="resumeNextRecord" class="btn btn-success">Resume from next record</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="treeContextMenu" class="tree-context-menu is-hidden"></div>

    <script type="module" src="popup.js"></script>
</body>
</html>




